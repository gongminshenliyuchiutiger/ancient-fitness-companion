<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>古法健身陪練計時系統</title>
    <style>
        :root {
            --primary-gold: #e6c17c;
            --secondary-blue: #8ab4f8;
            --dark-bg: #1f1f1f;
            --panel-bg-glass: rgba(44, 44, 44, 0.65);
            --text-light: #f0f0f0;
            --text-dark: #333;
            --completed-green: #58a87a;
            --danger-red: #a85858;
            --pause-yellow: #e6c17c;
            --rest-gray: #a9a9a9;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'KaiTi', 'SimSun', 'Microsoft YaHei', sans-serif; background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%232a2a2a" fill-opacity="0.4"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'), radial-gradient(circle, #3a3a3a 0%, var(--dark-bg) 100%); color: var(--text-light); margin: 0; padding: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; }
        
        button, select, label, input { font-family: inherit; }

        .main-container { width: 100%; max-width: 700px; background: var(--panel-bg-glass); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 30px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); text-align: center; position: relative; }
        
        .title-container { display: flex; align-items: center; justify-content: center; margin-bottom: 30px; }
        #title-tiger-icon { width: 50px; height: 50px; margin-right: 15px; flex-shrink: 0; }
        h1 { font-size: 2.8em; color: var(--primary-gold); margin: 0; text-shadow: 0 0 15px rgba(230, 193, 124, 0.5); }
        h2 { font-size: 2.2em; color: var(--primary-gold); margin: 0 0 15px; }
        h3 { font-size: 1.3em; margin: 20px 0 15px; color: var(--text-light); }
        
        .display-area { background-color: rgba(0,0,0,0.25); border-radius: 10px; padding: 25px; margin-bottom: 30px; min-height: 200px; box-shadow: inset 0 0 15px rgba(0,0,0,0.5); display: flex; flex-direction: column; justify-content: center; transition: all 0.3s ease; }
        #exercise-desc { font-size: 1.4em; line-height: 1.8; color: var(--text-light); transition: opacity 0.3s ease-in-out; }
        #exercise-desc.fade-out { opacity: 0; }

        .tabs { display: flex; justify-content: center; border-bottom: 1px solid rgba(255,255,255,0.2); margin-bottom: 25px; }
        .tab-button { background: none; border: none; color: var(--text-light); padding: 10px 20px; font-size: 1.2em; cursor: pointer; transition: all 0.3s ease; border-bottom: 3px solid transparent; opacity: 0.6; }
        .tab-button.active { color: var(--secondary-blue); border-bottom: 3px solid var(--secondary-blue); opacity: 1; }
        .tab-content { padding: 10px 0; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        
        #exercise-buttons-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .exercise-btn { background-color: rgba(255,255,255,0.1); border: 1px solid var(--primary-gold); color: var(--text-light); padding: 8px 15px; border-radius: 20px; cursor: pointer; transition: all 0.2s ease; }
        .exercise-btn:hover { background-color: var(--primary-gold); color: var(--text-dark); }
        .exercise-btn.active { background-color: var(--secondary-blue); color: var(--text-dark); border-color: var(--secondary-blue); font-weight: bold; }
        
        .settings-group { margin-bottom: 25px; }
        .settings-group h4 { font-size: 1.1em; color: var(--text-light); margin: 0 0 10px; font-weight: normal; }
        .button-group { display: flex; justify-content: center; gap: 10px; }
        .duration-btn { background-color: rgba(255,255,255,0.1); border: 1px solid #888; color: #ccc; padding: 8px 18px; border-radius: 20px; cursor: pointer; transition: all 0.2s ease; }
        .duration-btn:hover { border-color: var(--primary-gold); }
        .duration-btn.active { background-color: var(--primary-gold); color: var(--text-dark); border-color: var(--primary-gold); font-weight: bold; }
        
        .toggle-switch-group { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        .toggle-switch { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .toggle-switch-label { font-size: 1em; color: #ccc; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 26px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--secondary-blue); }
        input:checked + .slider:before { transform: translateX(24px); }

        .buttons button { font-size: 1em; padding: 10px 20px; margin: 5px; border-width: 1px; border-style: solid; color: var(--text-light); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
        .buttons button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .timer-btn { border-color: var(--primary-gold); background-color: rgba(230, 193, 124, 0.2); }
        .timer-btn:hover { background-color: var(--primary-gold); color: var(--text-dark); }
        .reset-btn { border-color: var(--danger-red); background-color: rgba(168, 88, 88, 0.2); }
        .reset-btn:hover { background-color: var(--danger-red); }
        
        #playlist-controls button { font-size: 1.1em; padding: 12px 25px; }
        .start-playlist { border-color: var(--completed-green); background-color: rgba(88, 168, 122, 0.2); }
        .start-playlist:hover { background-color: var(--completed-green); }
        .pause-resume-btn { border-color: var(--pause-yellow); background-color: rgba(230, 193, 124, 0.2); }
        .pause-resume-btn:hover { background-color: var(--pause-yellow); color: var(--text-dark); }
        .stop-playlist { border-color: var(--danger-red); background-color: rgba(168, 88, 88, 0.2); }
        .stop-playlist:hover { background-color: var(--danger-red); }
        
        .playlist-status { margin-top: 15px; font-size: 1.2em; color: var(--secondary-blue); min-height: 25px; font-weight: bold; }
        .progress-ring-container { position: relative; width: 150px; height: 150px; margin: 0 auto 5px; }
        .progress-ring-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .progress-ring-circle { transition: stroke-dashoffset 0.1s linear, stroke 0.3s ease; stroke-width: 12px; fill: transparent; }
        #progress-bg { stroke: rgba(0,0,0,0.3); }
        #progress-bar { stroke: var(--secondary-blue); stroke-linecap: round; filter: drop-shadow(0 0 5px var(--secondary-blue)); }
        #progress-bar.resting { stroke: var(--rest-gray); filter: drop-shadow(0 0 5px var(--rest-gray));}
        .progress-ring-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 3em; font-weight: bold; color: var(--text-light); }
        
        #playlist-progress-list { display: none; flex-wrap: wrap; gap: 8px; justify-content: center; margin: 0 0 25px 0; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .playlist-item { padding: 5px 12px; border-radius: 15px; border: 1px solid #777; font-size: 0.9em; cursor: pointer; transition: all 0.3s ease; }
        .playlist-item.completed { background-color: var(--completed-green); border-color: var(--completed-green); color: #fff; opacity: 0.7; }
        .playlist-item.current { background-color: var(--secondary-blue); border-color: var(--secondary-blue); color: var(--text-dark); font-weight: bold; transform: scale(1.1); box-shadow: 0 0 10px var(--secondary-blue); }

        #single-mode-video-wrapper { width: 100%; max-width: 250px; margin: 0 auto 20px; aspect-ratio: 1 / 1; border-radius: 50%; background-color: #000; overflow: hidden; }
        #fixed-video-container { position: fixed; bottom: 20px; left: 20px; width: 120px; height: 120px; border-radius: 50%; overflow: hidden; background-color: #000; box-shadow: 0 0 15px rgba(230, 193, 124, 0.6); border: 3px solid var(--primary-gold); z-index: 999; transition: transform 0.3s ease, opacity 0.3s ease, visibility 0.3s; visibility: hidden; opacity: 0; transform: scale(0.5); }
        #fixed-video-container.visible { visibility: visible; opacity: 1; transform: scale(1); }
        #exercise-video { width: 100%; height: 100%; object-fit: cover; display: none; }
        #exercise-video.ready { display: block; }
        
        #mascot-container { position: fixed; bottom: 20px; right: 20px; width: 100px; height: 100px; cursor: pointer; z-index: 1000; transition: transform 0.2s ease-out; }
        #mascot-container:hover { transform: scale(1.1) !important; /* Use important to override JS scaling on hover */ }
        #mascot-svg { width: 100%; height: 100%; filter: drop-shadow(0 0 8px rgba(255, 223, 150, 0.8)); animation: mascot-wobble 5s ease-in-out infinite; }
        @keyframes mascot-wobble { 0%, 100% { transform: translateY(0) rotate(0deg); } 20% { transform: translateY(-5px) rotate(-3deg); } 40% { transform: translateY(0) rotate(3deg); } 60% { transform: translateY(-2px) rotate(0deg); } 80% { transform: translateY(0) rotate(-2deg); } }
        .particle { position: fixed; width: 10px; height: 10px; border-radius: 50%; pointer-events: none; z-index: 1001; opacity: 1; transition: transform 1s ease-out, opacity 1s ease-out; }

        /* --- NEW: Mascot Message --- */
        #mascot-message {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--primary-gold);
            font-size: 1.8em;
            text-shadow: 0 0 10px var(--primary-gold);
            padding: 10px 20px;
            background: var(--panel-bg-glass);
            border-radius: 10px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s, top 0.5s ease;
            white-space: nowrap;
        }
        #mascot-message.visible {
            opacity: 1;
            visibility: visible;
            top: -80px;
        }

    </style>
</head>
<body>
    <div id="fixed-video-container"><video id="exercise-video" loop autoplay muted playsinline></video></div>

    <div class="main-container">
        <div id="mascot-message"></div>
        <div class="title-container"><svg id="title-tiger-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="tiger-gradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#ff9900;stop-opacity:1" /><stop offset="100%" style="stop-color:#ffcc00;stop-opacity:1" /></linearGradient></defs><g transform="translate(0, 5)"><path d="M25,85 C20,70 20,40 50,30 C80,40 80,70 75,85 L65,90 L35,90 Z" fill="url(#tiger-gradient)"/><path d="M30 50 C 35 60, 35 70, 30 80" stroke="#1f1f1f" stroke-width="2.5" fill="none" stroke-linecap="round"/><path d="M70 50 C 65 60, 65 70, 70 80" stroke="#1f1f1f" stroke-width="2.5" fill="none" stroke-linecap="round"/><path d="M25 65 C 28 70, 28 75, 25 80" stroke="#1f1f1f" stroke-width="2" fill="none" stroke-linecap="round" opacity="0.8"/><path d="M75 65 C 72 70, 72 75, 75 80" stroke="#1f1f1f" stroke-width="2" fill="none" stroke-linecap="round" opacity="0.8"/><circle cx="50" cy="25" r="20" fill="url(#tiger-gradient)"/><circle cx="35" cy="10" r="7" fill="url(#tiger-gradient)"/><circle cx="65" cy="10" r="7" fill="url(#tiger-gradient)"/><circle cx="36" cy="11" r="4" fill="#f0f0f0"/><circle cx="64" cy="11" r="4" fill="#f0f0f0"/><circle cx="45" cy="25" r="2" fill="#1f1f1f"/><circle cx="55" cy="25" r="2" fill="#1f1f1f"/><path d="M 48 30 Q 50 32 52 30" stroke="#1f1f1f" stroke-width="1.5" fill="none" stroke-linecap="round"/><g stroke="#1f1f1f" stroke-width="2" stroke-linecap="round"><path d="M45 12 h10" /><path d="M43 16 h14" /><path d="M46 20 h8" /><path d="M50 12 v8" /></g><circle cx="38" cy="70" r="8" fill="url(#tiger-gradient)"/><circle cx="62" cy="70" r="8" fill="url(#tiger-gradient)"/></g></svg>
            <h1>古法健身陪練計時系統</h1>
        </div>
        <div class="display-area">
            <h2 id="exercise-name"></h2>
            <div id="single-mode-video-wrapper"></div>
            <div id="playlist-visual-timer" style="display: none;"><div class="progress-ring-container"><svg class="progress-ring-svg"><circle r="69" cx="75" cy="75" id="progress-bg" class="progress-ring-circle"/><circle r="69" cx="75" cy="75" id="progress-bar" class="progress-ring-circle"/></svg><div id="progress-text" class="progress-ring-text"></div></div></div>
            <div class="playlist-status"><span id="playlist-info"></span></div>
            <p id="exercise-desc"></p>
        </div>
        <div class="tabs"><button class="tab-button active" data-tab="1">單式練習</button><button class="tab-button" data-tab="2">連續練習</button></div>
        <div class="tab-content">
            <div id="tab-1" class="tab-panel active">
                <div id="exercise-buttons-container"></div>
                <div class="manual-timer-area"><h3>手動計時器</h3><div id="timer-display" class="display">00:00.0</div><div class="buttons"><button id="start-pause-btn" class="timer-btn">開始</button><button id="reset-timer-btn" class="reset-btn">重置</button></div></div>
            </div>
            <div id="tab-2" class="tab-panel">
                <div id="playlist-progress-list"></div>
                <h3>練習設定</h3>
                <div class="settings-group">
                    <h4>每式時長</h4>
                    <div id="duration-buttons" class="button-group">
                        <button class="duration-btn" data-value="30">30 秒</button>
                        <button class="duration-btn active" data-value="60">1 分鐘</button>
                        <button class="duration-btn" data-value="120">2 分鐘</button>
                        <button class="duration-btn" data-value="180">3 分鐘</button>
                    </div>
                </div>
                <div class="settings-group">
                    <h4>功能選項</h4>
                    <div class="toggle-switch-group">
                        <div class="toggle-switch"><span class="toggle-switch-label">轉換休息</span><label class="switch"><input type="checkbox" id="rest-toggle-checkbox"><span class="slider"></span></label></div>
                        <div class="toggle-switch"><span class="toggle-switch-label">循環播放</span><label class="switch"><input type="checkbox" id="loop-checkbox"><span class="slider"></span></label></div>
                        <div class="toggle-switch"><span class="toggle-switch-label">語音報讀</span><label class="switch"><input type="checkbox" id="voice-toggle-checkbox"><span class="slider"></span></label></div>
                        <div class="toggle-switch"><span class="toggle-switch-label">示範影片</span><label class="switch"><input type="checkbox" id="show-video-checkbox"><span class="slider"></span></label></div>
                    </div>
                </div>
                <div id="playlist-controls" class="buttons">
                    <button id="start-playlist-btn" class="start-playlist">開始整套練習</button>
                    <button id="pause-resume-btn" class="pause-resume-btn" style="display:none;">暫停練習</button>
                    <button id="stop-playlist-btn" class="stop-playlist" style="display:none;">停止練習</button>
                </div>
            </div>
        </div>
    </div>
    <footer>Copyright © Liyuchiutiger Gongminshen</footer>
    <div id="mascot-container"><img id="mascot-svg" src="image/LiyuChill.svg" alt="吉祥物"></div>
    <script>
    const allDOMElements = {
        exName: document.getElementById('exercise-name'), exDesc: document.getElementById('exercise-desc'), loopCheckbox: document.getElementById('loop-checkbox'), startPlaylistBtn: document.getElementById('start-playlist-btn'), stopPlaylistBtn: document.getElementById('stop-playlist-btn'), pauseResumeBtn: document.getElementById('pause-resume-btn'), playlistInfo: document.getElementById('playlist-info'), visualTimer: document.getElementById('playlist-visual-timer'), progressBar: document.getElementById('progress-bar'), progressText: document.getElementById('progress-text'), timerDisplay: document.getElementById('timer-display'), startPauseBtn: document.getElementById('start-pause-btn'), resetTimerBtn: document.getElementById('reset-timer-btn'), tabs: document.querySelectorAll('.tab-button'), tabPanels: document.querySelectorAll('.tab-panel'), manualTimerArea: document.querySelector('.manual-timer-area'),
        voiceToggle: document.getElementById('voice-toggle-checkbox'),
        fixedVideoContainer: document.getElementById('fixed-video-container'), videoPlayer: document.getElementById('exercise-video'), singleModeVideoWrapper: document.getElementById('single-mode-video-wrapper'),
        showVideoCheckbox: document.getElementById('show-video-checkbox'),
        playlistStatusDiv: document.querySelector('.playlist-status'),
        exerciseButtonsContainer: document.getElementById('exercise-buttons-container'),
        playlistProgressList: document.getElementById('playlist-progress-list'),
        durationButtonsContainer: document.getElementById('duration-buttons'),
        mascotContainer: document.getElementById('mascot-container'),
        mascotMessage: document.getElementById('mascot-message'),
        restToggle: document.getElementById('rest-toggle-checkbox'),
    };
    
    const radius = allDOMElements.progressBar.r.baseVal.value, circumference = radius * 2 * Math.PI;
    allDOMElements.progressBar.style.strokeDasharray = `${circumference} ${circumference}`;
    
    let audioContext;
    const initAudioContext = () => { if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)(); };
    function playNote(freq, type, startTime, duration, vol = 1) { if (!audioContext) return; const o = audioContext.createOscillator(); const g = audioContext.createGain(); o.frequency.setValueAtTime(freq, startTime); o.type = type; g.gain.setValueAtTime(vol, startTime); g.gain.exponentialRampToValueAtTime(0.0001, startTime + duration); o.connect(g); g.connect(audioContext.destination); o.start(startTime); o.stop(startTime + duration); }
    const playStartSound = () => { const now = audioContext.currentTime; playNote(523.25, 'sine', now, 0.15, 0.3); playNote(659.26, 'sine', now + 0.1, 0.15, 0.3); playNote(783.99, 'sine', now + 0.2, 0.15, 0.3); };
    const playEndWarningSound = () => { const now = audioContext.currentTime; playNote(783.99, 'triangle', now, 0.1, 0.4); playNote(523.25, 'triangle', now + 0.15, 0.1, 0.4); };
    const playCompleteSound = () => { const now = audioContext.currentTime; playNote(523.25, 'sine', now, 0.15); playNote(659.26, 'sine', now + 0.15, 0.15); playNote(783.99, 'sine', now + 0.3, 0.15); playNote(1046.50, 'sine', now + 0.45, 0.3); };
    const playClickSound = () => playNote(1200, 'triangle', audioContext.currentTime, 0.1, 0.2);
    const playExplosionSound = () => { const now = audioContext.currentTime; playNote(100, 'sine', now, 0.4, 0.8); const noiseSource = audioContext.createBufferSource(); const bufferSize = audioContext.sampleRate * 0.3; const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate); const data = buffer.getChannelData(0); for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1; noiseSource.buffer = buffer; const gainNode = audioContext.createGain(); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.3); noiseSource.connect(gainNode); gainNode.connect(audioContext.destination); noiseSource.start(now); };
    
    const speakText = (text, force = false) => { if ('speechSynthesis' in window && (allDOMElements.voiceToggle.checked || force)) { window.speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(text); utterance.lang = 'zh-TW'; utterance.rate = 1.1; utterance.pitch = 1.0; window.speechSynthesis.speak(utterance); } };

    const exercises = [ { id: 'mabu-yao', name: '馬步搖', description: '雙腳開立，寬於肩，腳尖朝前。屈膝下蹲，大腿與地面平行，重心在兩腿之間。上身中正，以腰胯帶動重心緩慢左右移動，感受大腿內側的拉伸與力量。' }, { id: 'fenghuolun', name: '風火輪', description: '左腳在前成弓步，右手握拳，以肩為軸，由後向前、向上畫立圓，如車輪滾動。腰胯隨之轉動，目光注視前方。完成後換邊練習。' }, { id: 'shangxia-qifa', name: '上下齊發', description: '自然站立，雙手在腹前交疊。吸氣時，一手掌心向上托至頭頂，另一手掌心向下按至胯旁，身體有上下對拉的伸展感。呼氣還原，交替進行。' }, { id: 'yingji-changkong', name: '鷹擊長空', description: '穩坐馬步，雙臂在胸前交叉。吸氣時，雙臂如鷹翼般向兩側緩緩展開，挺胸抬頭，感受胸背的開闊。呼氣時緩慢收回。' }, { id: 'xuanzhuan-qiankun', name: '旋轉乾坤', description: '雙腳與肩同寬，膝蓋微曲。雙手在胸前做抱球狀，以腰為軸心，帶動雙臂與上半身向左側緩慢旋轉至極限，稍作停留後轉向右側。' }, { id: 'gongbu-xuanji', name: '弓步旋脊', description: '左腳在前成弓步。身體向左後方轉體，右手向前推出，左手向後伸展，目光隨左手遠望。感受脊柱的扭轉拉伸。完成後換邊。' }, { id: 'mabu-cezhan', name: '馬步側展', description: '穩坐馬步。左手上舉，貼近耳朵，呼氣時身体向右側彎曲，感受左側腰背的強力拉伸。吸氣還原。完成後換邊練習。' }, { id: 'mabu-ningyao', name: '馬步擰腰', description: '穩坐馬步，雙臂側平舉。以腰為軸，帶動上半身向左側轉動，雙臂保持水平。目光隨左手移動。完成後換邊練習。' }, { id: 'niuyao-baikua', name: '扭腰擺跨', description: '雙腳與肩同寬，膝蓋微曲放鬆。以腰胯為中心，左右畫平圓，帶動整個骨盆和腰部活動開來，動作盡量圓活、放鬆。' }, { id: 'zuoyou-lajin', name: '左右拉筋', description: '雙腳大開立。重心移至右腿，屈膝下蹲成僕步，左腿完全伸直，腳尖內扣。感受左大腿內側的強烈拉伸感。保持片刻後換邊。' }, { id: 'xuanlong-ji', name: '旋龍脊', description: '馬步站立，雙手扶膝。身体前傾，從尾椎開始，一節一節地向前、向左、向後、向右，做圓形轉動，感受整條脊柱如龍般盤旋。' }, { id: 'chuanzhang-lanyue', name: '穿掌攬月', description: '穩坐馬步。雙手由下往上，在胸前交錯，左手上穿至頭頂，右手下按至腹前，如懷中抱月。眼隨上手。交替進行，動作連貫。' }, { id: 'jiaolong-youzou', name: '蛟龍遊走', description: '左腳在前成弓步，壓低重心。身体向前、向左、向下探出，再收回，整個運動軌跡如蛟龍在水中潛行。感受全身力量的協同與流動。完成後換邊。' } ];
    
    let currentExerciseId = exercises[0].id, selectedDuration = 60, lastSpokenSecond = -1;

    function setProgress(percent) { allDOMElements.progressBar.style.strokeDashoffset = circumference - (percent / 100) * circumference; }
    
    function updateExerciseDisplay(id, withFade = false) {
        currentExerciseId = id;
        const ex = exercises.find(e => e.id === id); if (!ex) return;
        const videoSrc = `video/${ex.name}.mp4`;
        if (!allDOMElements.videoPlayer.currentSrc.endsWith(encodeURI(videoSrc))) {
            allDOMElements.videoPlayer.classList.remove('ready'); allDOMElements.videoPlayer.src = videoSrc; allDOMElements.videoPlayer.load(); allDOMElements.videoPlayer.play().catch(()=>{});
        }
        const updateText = () => { allDOMElements.exName.textContent = ex.name; allDOMElements.exDesc.textContent = ex.description; if (withFade) allDOMElements.exDesc.classList.remove('fade-out'); };
        if (withFade) { allDOMElements.exDesc.classList.add('fade-out'); setTimeout(updateText, 150); } else { updateText(); }
        document.querySelectorAll('.exercise-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.id === id));
    }
    
    let playlistTimer = null, countdownTimer = null, currentExIndex = 0, isPlaylistActive = false, isPaused = false, timeRemainingOnPause = 0, pauseStartTime = 0;
    
    function setVideoMode(mode) {
        const video = allDOMElements.videoPlayer;
        if (mode === 'playlist') {
            allDOMElements.fixedVideoContainer.appendChild(video); allDOMElements.singleModeVideoWrapper.style.display = 'none';
        } else {
            allDOMElements.singleModeVideoWrapper.appendChild(video); allDOMElements.singleModeVideoWrapper.style.display = 'block'; allDOMElements.fixedVideoContainer.classList.remove('visible');
        }
    }

    function startPlaylist() {
        initAudioContext(); isPlaylistActive = true; isPaused = false; currentExIndex = 0;
        setVideoMode('playlist');
        allDOMElements.startPlaylistBtn.style.display = 'none'; allDOMElements.pauseResumeBtn.style.display = 'inline-block'; allDOMElements.stopPlaylistBtn.style.display = 'inline-block';
        allDOMElements.pauseResumeBtn.textContent = '暫停練習'; allDOMElements.manualTimerArea.style.display = 'none';
        allDOMElements.tabs.forEach(t => t.style.pointerEvents = 'none');
        allDOMElements.playlistStatusDiv.style.display = 'block'; allDOMElements.visualTimer.style.display = 'block'; allDOMElements.exDesc.style.display = 'block';
        renderPlaylistProgress(); allDOMElements.playlistProgressList.style.display = 'flex';
        toggleVideoVisibility(allDOMElements.showVideoCheckbox.checked);
        playNextExercise();
    }
    
    function stopPlaylist() {
        isPlaylistActive = false; isPaused = false; clearTimeout(playlistTimer); clearInterval(countdownTimer);
        window.speechSynthesis.cancel(); setVideoMode('single');
        allDOMElements.startPlaylistBtn.style.display = 'inline-block'; allDOMElements.pauseResumeBtn.style.display = 'none'; allDOMElements.stopPlaylistBtn.style.display = 'none';
        allDOMElements.manualTimerArea.style.display = 'block'; allDOMElements.tabs.forEach(t => t.style.pointerEvents = 'auto');
        allDOMElements.visualTimer.style.display = 'none'; allDOMElements.playlistStatusDiv.style.display = 'none'; allDOMElements.playlistProgressList.style.display = 'none';
        updateExerciseDisplay(currentExerciseId, true);
    }

    function togglePauseResume() {
        if (!isPlaylistActive) return;
        isPaused = !isPaused;
        if (isPaused) {
            clearTimeout(playlistTimer); clearInterval(countdownTimer);
            timeRemainingOnPause -= (Date.now() - pauseStartTime);
            allDOMElements.pauseResumeBtn.textContent = '繼續練習'; window.speechSynthesis.pause();
            allDOMElements.tabs.forEach(t => t.style.pointerEvents = 'auto');
        } else {
            pauseStartTime = Date.now();
            allDOMElements.pauseResumeBtn.textContent = '暫停練習'; window.speechSynthesis.resume();
            allDOMElements.tabs.forEach(t => t.style.pointerEvents = 'none');
            countdownTimer = setInterval(updateCountdown, 100);
            playlistTimer = setTimeout(handleExerciseEnd, timeRemainingOnPause);
        }
    }

    function updateCountdown() {
        let timeLeft = isPaused ? timeRemainingOnPause : timeRemainingOnPause - (Date.now() - pauseStartTime);
        if (timeLeft <= 0) { timeLeft = 0; clearInterval(countdownTimer); }
        setProgress(timeLeft / (selectedDuration * 1000) * 100);
        const secondsLeft = Math.ceil(timeLeft / 1000);
        allDOMElements.progressText.textContent = secondsLeft;
        if (secondsLeft !== lastSpokenSecond) {
            if (allDOMElements.voiceToggle.checked && selectedDuration > 10) {
                if (secondsLeft === 10) speakText("剩下10秒");
                else if (secondsLeft <= 3 && secondsLeft > 0) speakText(String(secondsLeft));
            }
            lastSpokenSecond = secondsLeft;
        }
    }
    
    function handleExerciseEnd() {
        currentExIndex++;
        if (allDOMElements.restToggle.checked) {
            startRestPeriod();
        } else {
            playNextExercise();
        }
    }
    
    function startRestPeriod() {
        clearTimeout(playlistTimer); clearInterval(countdownTimer);
        allDOMElements.progressBar.classList.add('resting');
        allDOMElements.exName.textContent = "休息時間";
        allDOMElements.exDesc.textContent = "";
        let restTimeLeft = 3;
        speakText(`休息 ${restTimeLeft} 秒`);
        
        const updateRestCountdown = () => {
            setProgress(restTimeLeft / 3 * 100);
            allDOMElements.progressText.textContent = restTimeLeft;
            if (restTimeLeft <= 0) {
                clearInterval(restTimer);
                allDOMElements.progressBar.classList.remove('resting');
                playNextExercise();
            }
            restTimeLeft--;
        };
        updateRestCountdown();
        const restTimer = setInterval(updateRestCountdown, 1000);
    }

    function jumpToExercise(index) {
        if (!isPlaylistActive || isPaused) return;
        clearTimeout(playlistTimer); clearInterval(countdownTimer);
        currentExIndex = index;
        playNextExercise();
    }

    function renderPlaylistProgress() {
        allDOMElements.playlistProgressList.innerHTML = '';
        exercises.forEach((ex, index) => {
            const item = document.createElement('div');
            item.className = 'playlist-item'; item.textContent = ex.name; item.dataset.index = index;
            item.addEventListener('click', () => jumpToExercise(index));
            allDOMElements.playlistProgressList.appendChild(item);
        });
    }

    function updatePlaylistProgressUI(activeIndex) {
        document.querySelectorAll('.playlist-item').forEach((item, index) => {
            item.classList.remove('current', 'completed');
            if (index < activeIndex) item.classList.add('completed');
            else if (index === activeIndex) item.classList.add('current');
        });
    }
    
    function playNextExercise() {
        if (!isPlaylistActive) return;
        if (currentExIndex >= exercises.length) {
            if (allDOMElements.loopCheckbox.checked) { currentExIndex = 0; }
            else { playCompleteSound(); allDOMElements.playlistInfo.textContent = '恭喜！已完成整套練習！'; stopPlaylist(); return; }
        }
        lastSpokenSecond = -1;
        const ex = exercises[currentExIndex];
        timeRemainingOnPause = selectedDuration * 1000;
        pauseStartTime = Date.now();
        updateExerciseDisplay(ex.id, true); updatePlaylistProgressUI(currentExIndex); playStartSound();
        speakText(`${ex.name}。 ${ex.description}`);
        const nextExName = exercises[currentExIndex + 1]?.name || (allDOMElements.loopCheckbox.checked ? exercises[0].name : '完成練習');
        allDOMElements.playlistInfo.textContent = `下一式: ${nextExName}`;
        clearInterval(countdownTimer); updateCountdown();
        countdownTimer = setInterval(updateCountdown, 100);
        const warningTimeout = timeRemainingOnPause > 3000 ? timeRemainingOnPause - 3000 : 0;
        setTimeout(() => { if (!isPaused) playEndWarningSound(); }, warningTimeout);
        playlistTimer = setTimeout(handleExerciseEnd, timeRemainingOnPause);
    }
    
    let timerInterval=null,manualStartTime=0,manualElapsedTime=0,manualIsRunning=false;function formatTime(t){const e=Math.floor(t/6e4),s=Math.floor(t%6e4/1e3),n=Math.floor(t%1e3/100);return`${String(e).padStart(2,"0")}:${String(s).padStart(2,"0")}.${n}`}function updateManualTimer(){const t=Date.now();manualElapsedTime=t-manualStartTime,allDOMElements.timerDisplay.textContent=formatTime(manualElapsedTime)}allDOMElements.startPauseBtn.addEventListener("click",()=>{manualIsRunning?(clearInterval(timerInterval),manualElapsedTime=Date.now()-manualStartTime,manualIsRunning=!1,allDOMElements.startPauseBtn.textContent="繼續"):(manualStartTime=Date.now()-manualElapsedTime,timerInterval=setInterval(updateManualTimer,100),manualIsRunning=!0,allDOMElements.startPauseBtn.textContent="暫停")});allDOMElements.resetTimerBtn.addEventListener("click",()=>{clearInterval(timerInterval),manualIsRunning=!1,manualElapsedTime=0,manualStartTime=0,allDOMElements.timerDisplay.textContent="00:00.0",allDOMElements.startPauseBtn.textContent="開始"});
    
    function toggleVideoVisibility(show) { allDOMElements.fixedVideoContainer.classList.toggle('visible', show && isPlaylistActive); }

    let lastClickTime = 0, clickCombo = 0, mascotScale = 1;
    const comboThreshold = 5, comboTimeout = 300;
    function createParticles(x, y, isExplosion = false) { const particleCount = isExplosion ? 100 : 25; const colors = ['#FFD700', '#FF69B4', '#00BFFF', '#7CFC00', '#FF4500', '#9400D3']; for (let i = 0; i < particleCount; i++) { const particle = document.createElement('div'); particle.classList.add('particle'); particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)]; const size = Math.random() * (isExplosion ? 12 : 8) + 4; particle.style.width = `${size}px`; particle.style.height = `${size}px`; particle.style.left = `${x}px`; particle.style.top = `${y}px`; document.body.appendChild(particle); const angle = Math.random() * Math.PI * 2; const distance = Math.random() * (isExplosion ? 500 : 300) + 100; const endX = Math.cos(angle) * distance; const endY = Math.sin(angle) * distance; requestAnimationFrame(() => { particle.style.transform = `translate(${endX}px, ${endY}px) scale(0)`; particle.style.opacity = '0'; }); setTimeout(() => { particle.remove(); }, 1000); } }
    
    function initialize() {
        exercises.forEach(ex => {
            const btn = document.createElement('button');
            btn.className = 'exercise-btn'; btn.dataset.id = ex.id; btn.textContent = ex.name;
            allDOMElements.exerciseButtonsContainer.appendChild(btn);
        });
        
        allDOMElements.exerciseButtonsContainer.addEventListener('click', e => {
            const btn = e.target.closest('.exercise-btn');
            if (btn && !isPlaylistActive) updateExerciseDisplay(btn.dataset.id, true);
        });

        allDOMElements.durationButtonsContainer.addEventListener('click', e => {
            const btn = e.target.closest('.duration-btn');
            if (btn) {
                selectedDuration = parseInt(btn.dataset.value);
                document.querySelectorAll('.duration-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                if(isPlaylistActive && !isPaused) jumpToExercise(currentExIndex);
            }
        });

        allDOMElements.startPlaylistBtn.addEventListener('click', startPlaylist);
        allDOMElements.stopPlaylistBtn.addEventListener('click', stopPlaylist);
        allDOMElements.pauseResumeBtn.addEventListener('click', togglePauseResume);

        allDOMElements.tabs.forEach(tab => tab.addEventListener('click', () => {
            if (isPlaylistActive && !isPaused) return; // Prevent switching during active play
            allDOMElements.tabs.forEach(t => t.classList.remove('active')); tab.classList.add('active');
            allDOMElements.tabPanels.forEach(panel => panel.classList.toggle('active', panel.id === `tab-${tab.dataset.tab}`));
            setVideoMode(tab.dataset.tab === '2' && isPlaylistActive ? 'playlist' : 'single');
            updateExerciseDisplay(currentExerciseId);
        }));
        
        allDOMElements.showVideoCheckbox.addEventListener('change', e => toggleVideoVisibility(e.target.checked));
        allDOMElements.voiceToggle.addEventListener('change', e => {
            if(!e.target.checked) { window.speechSynthesis.cancel(); }
            else if (isPlaylistActive && !isPaused) { const ex = exercises[currentExIndex]; speakText(`${ex.name}。 ${ex.description}`, true); }
        });
        
        allDOMElements.videoPlayer.addEventListener('loadeddata', () => allDOMElements.videoPlayer.classList.add('ready'));
        allDOMElements.videoPlayer.addEventListener('error', () => allDOMElements.videoPlayer.classList.remove('ready'));

        allDOMElements.mascotContainer.addEventListener('click', (e) => {
            initAudioContext(); const currentTime = Date.now();
            if (currentTime - lastClickTime < comboTimeout) { clickCombo++; } else { clickCombo = 1; mascotScale = 1.1; }
            lastClickTime = currentTime;
            const rect = allDOMElements.mascotContainer.getBoundingClientRect();
            const clickX = rect.left + rect.width / 2; const clickY = rect.top + rect.height / 2;
            
            if (clickCombo >= comboThreshold) {
                playExplosionSound(); createParticles(clickX, clickY, true);
                allDOMElements.mascotMessage.textContent = "成為健康神，不再只是夢想！";
                allDOMElements.mascotMessage.classList.add('visible');
                setTimeout(() => allDOMElements.mascotMessage.classList.remove('visible'), 3000);
                clickCombo = 0; mascotScale = 1;
            } else {
                playClickSound(); createParticles(clickX, clickY, false);
                mascotScale += 0.15;
            }
            allDOMElements.mascotContainer.style.transform = `scale(${mascotScale})`;
        });

        setVideoMode('single');
        updateExerciseDisplay(exercises[0].id);
        document.body.addEventListener('click', initAudioContext, { once: true });
    }
    document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>